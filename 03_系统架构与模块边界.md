# 系统架构与模块边界

## 1. 总体形态
- 单体：apps/ems-api 为唯一可执行
- 依赖：Postgres+Timescale、Redis、MQTT Broker
- 开发环境：WSL2（Windows 仅 IDE 外壳）

## 2. 仓库结构（Monorepo）
- 后端：Rust workspace（apps + crates）
- 前端：web/admin（pure-admin-thin）

## 3. 模块边界（crates）
### 3.1 core
- domain：实体/值对象/业务规则（不依赖 web/db）
- api-contract：DTO/OpenAPI/ErrorCode（稳定契约）

### 3.2 capability
- auth：JWT/RBAC/Scope，输出 TenantContext
- storage：PG/Timescale/Redis 的接口与实现
- ingest：Source 抽象 + RawEvent
- normalize：PointMappingProvider + Normalizer
- pipeline：Dedup/Quality/BatchWrite/Retry/Backpressure
- control：CommandService + Dispatcher + Receipt + Audit
- alarm：RuleService + Engine 接口占位
- scheduler：Job 抽象与任务编排
- telemetry：log/trace/metrics
- config：配置加载

## 4. 依赖方向硬规则
- domain 不依赖任何 crate
- api-contract 不依赖 storage/web
- 业务模块只依赖 domain/api-contract（和必要的 trait）
- ems-api 负责装配与启动，其他 crate 禁止反向依赖 ems-api

## 5. 数据流与控制流
### 5.1 数据流（采集）
Source(MQTT/Modbus/TCP) → RawEvent → normalize → PointValue → pipeline → 
- Timescale(measurement)
- Redis(last_value/online)

### 5.2 控制流
API → auth/permission → command service → dispatcher → receipt → audit/event

## 6. 多租户上下文（不变量）
- 每个请求与后台任务都有 TenantContext：
  - tenant_id / user_id / roles / permissions / scope(project_id?)
- tenant_id 不写入 URL；从 JWT/Context 提取，避免串租
- project_id 出现在 URL 时，必须校验归属当前 tenant
