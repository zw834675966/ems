# 里程碑完成总结（M0-M5）

本文用于回答“当前项目已经完成 M0-M5 的哪一步”，并汇总每个里程碑的落地情况与可验证产物。

## 结论（里程碑口径）
- 当前工程能力层面已覆盖 M0-M4，并具备进入 M5（验收/回归）的条件：验收脚本与稳定性脚本齐备，且新增 `/metrics`（需 Bearer token + `SYSTEM.METRICS.READ`）用于回归断言。
- 是否“已完成 M5（已验收）”：取决于在具备依赖环境（Postgres/Timescale、Redis、MQTT）下实际执行并通过 `scripts/mvp-acceptance.sh` / `scripts/stability-check.sh` 的结果。

## M0-M5 对照表（完成情况）

### M0 环境就绪（已具备）
- 依赖编排：`docker-compose.yml`
- 初始化：`scripts/db-init.sh`、`migrations/*.sql`
- 依赖健康检查：`scripts/health-check.sh`
- 开发工作流说明：`06_开发环境与工作流_WSL2.md`

### M1 账号与项目资源 + 最小前端联调（已完成）
- 认证与动态路由：`apps/ems-api/src/handlers/auth.rs`、`apps/ems-api/src/routes.rs`
- RBAC 管理 API：`apps/ems-api/src/handlers/rbac.rs`
- 项目/资产 CRUD：`apps/ems-api/src/handlers/projects.rs`、`gateways.rs`、`devices.rs`、`points.rs`、`point_mappings.rs`
- 前端页面：`web/admin/src/views/ems/projects`、`gateways`、`devices`、`points`、`point-mappings`、`rbac`

### M2 采集与查询（已完成）
- ingest/normalize/pipeline 接线：`apps/ems-api/src/ingest.rs`
- MQTT ingest：`crates/capability/ingest/src/lib.rs`
- normalize：`crates/capability/normalize/src/lib.rs`
- pipeline（去重/批写/背压/重试）：`crates/capability/pipeline/src/lib.rs`
- 存储（Timescale/Redis）：`crates/capability/storage/src/postgres/measurement.rs`、`crates/capability/storage/src/redis.rs`
- API：`apps/ems-api/src/handlers/realtime.rs`、`apps/ems-api/src/handlers/measurements.rs`
- 模拟上报：`scripts/mqtt-simulate.sh`

### M3 控制链路（已完成）
- commands/receipts/audit 表：`migrations/005_control.sql`
- 控制服务与 MQTT dispatcher/receipt listener：`crates/capability/control/src/lib.rs`
- API：`apps/ems-api/src/handlers/commands.rs`、`apps/ems-api/src/handlers/audit.rs`
- 设备侧模拟与回执模拟：
  - `scripts/device-emulator.sh`
  - `scripts/control-receipt-simulate.sh`
- 真实设备联调兼容性（已增强）：服务端兼容回执 topic 额外层级与多种 payload 字段（见 `07_项目执行任务.md`“设备侧回执联调清单”）。

### M4 前端深度联调（已完成）
- 实时/历史/控制/审计页面：`web/admin/src/views/ems/realtime`、`measurements`、`commands`、`audit`
- 对接契约说明：`05_API契约与前端对接.md`

### M5 验收与回归（已具备，待执行确认）
- MVP 验收脚本（登录→创建资源→实时/历史→控制→审计/回执 + 指标断言）：`scripts/mvp-acceptance.sh`
- 稳定性回归脚本：`scripts/stability-check.sh`
- RBAC 管理面回归脚本：`scripts/rbac-acceptance.sh`
- 指标快照接口（用于回归断言）：`apps/ems-api/src/handlers/metrics.rs`（`GET /metrics`，需 Bearer token + `SYSTEM.METRICS.READ`）

## 建议验收执行顺序（判定 M5 是否“已完成”）
在具备依赖环境的机器上执行：
```bash
docker compose up -d
scripts/mvp-acceptance.sh
scripts/stability-check.sh
```
说明：`docker compose up -d` 默认仅启动依赖（Postgres/Redis/MQTT）；如需一键拉起完整应用栈（含 `ems-api`/`web-admin`/`db-init`），使用 `docker compose --profile app up -d`。

## 参考文档
- 执行任务与验收口径：`07_项目执行任务.md`
- 完成进度记录：`09_完成进度.md`
