# 数据模型与存储设计

## 1. 存储组件
- Postgres：元数据（租户/项目/用户/资产/映射/审计/规则）
- TimescaleDB：时序（measurement、event）
- Redis：实时镜像（last_value、online、可选 token blacklist/lock）
- MQTT：采集与控制通道

## 2. 数据隔离策略
- MVP：单库单 schema + tenant_id 强制
- 所有业务表必须包含 tenant_id
- 项目内资源必须包含 project_id
- Timescale hypertable 也必须包含 tenant_id + project_id（避免串租与提升过滤效率）

## 3. 元数据建议表（MVP）
- tenants(tenant_id, name, status, created_at)
- projects(project_id, tenant_id, name, timezone, created_at)
- users(user_id, tenant_id, username, password_hash, status, created_at)
- roles(role_code, name)
- permissions(permission_code, desc)
- user_roles(user_id, role_code)
- role_permissions(role_code, permission_code)

- gateways(gateway_id, tenant_id, project_id, name, status, last_seen_at)
- devices(device_id, tenant_id, project_id, gateway_id, name, model)
- points(point_id, tenant_id, project_id, device_id, key, data_type, unit, ...)
- point_sources(source_id, tenant_id, project_id, point_id, source_type, address/topic, scale, offset, ...)

- commands(command_id, tenant_id, project_id, target, payload, status, issued_by, issued_at)
- command_receipts(receipt_id, tenant_id, project_id, command_id, ts, status, message)
- audit_logs(audit_id, tenant_id, project_id?, actor, action, resource, result, ts)

## 4. 时序表（Timescale hypertable）
### 4.1 measurement
- tenant_id, project_id, point_id
- ts
- value（可按查询模式选择：数值分列 / jsonb）
- quality

### 4.2 event（告警/状态变化/回执等）
- tenant_id, project_id
- ts
- type（alarm/online/receipt/...）
- payload(jsonb)
- 备注：可用于统一检索与审计补强

## 5. Redis Key 规范（必须统一）
- last_value:
  - tenant:{tid}:project:{pid}:point:{point_id}:last_value
- online:
  - tenant:{tid}:project:{pid}:gateway:{gid}:online
  - tenant:{tid}:project:{pid}:device:{did}:online

## 6. 保留策略（先写原则，后落地）
- measurement：按项目/租户的 retention（如 90/180/365 天）
- 压缩策略：按时间窗口压缩
- 复审：当数据量达到阈值时启用自动化 job（scheduler）
