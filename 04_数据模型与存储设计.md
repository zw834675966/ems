# 数据模型与存储设计

## 1. 存储组件
- Postgres：元数据（租户/项目/用户/资产/映射/审计/规则）
- TimescaleDB：时序（measurement、event）
- Redis：实时镜像（last_value、online、可选 token blacklist/lock）
- MQTT：采集与控制通道

## 2. 数据隔离策略
- MVP：单库单 schema + tenant_id 强制
- 所有业务表必须包含 tenant_id
- 项目内资源必须包含 project_id
- Timescale hypertable 也必须包含 tenant_id + project_id（避免串租与提升过滤效率）

## 3. 元数据建议表（MVP）
- tenants(tenant_id, name, status, created_at)
- projects(project_id, tenant_id, name, timezone, created_at)
- users(user_id, tenant_id, username, password_hash, refresh_jti, status, created_at)
- roles(role_code, name)
- permissions(permission_code, desc)
- user_roles(user_id, role_code)
- role_permissions(role_code, permission_code)

- gateways(gateway_id, tenant_id, project_id, name, status, last_seen_at)
- devices(device_id, tenant_id, project_id, gateway_id, name, model)
- points(point_id, tenant_id, project_id, device_id, key, data_type, unit, ...)
- point_sources(source_id, tenant_id, project_id, point_id, source_type, address/topic, scale, offset, ...)

- commands(command_id, tenant_id, project_id, target, payload, status, issued_by, issued_at)
- command_receipts(receipt_id, tenant_id, project_id, command_id, ts, status, message)
- audit_logs(audit_id, tenant_id, project_id?, actor, action, resource, result, detail, ts)

## 4. 时序表（Timescale hypertable）
### 4.1 measurement
- tenant_id, project_id, point_id
- ts
- value（可按查询模式选择：数值分列 / jsonb）
- quality

### 4.2 event（告警/状态变化/回执等）
- tenant_id, project_id
- ts
- type（alarm/online/receipt/...）
- payload(jsonb)
- 备注：可用于统一检索与审计补强

## 5. Redis Key 规范（必须统一）
- last_value:
  - tenant:{tid}:project:{pid}:point:{point_id}:last_value
- online:
  - tenant:{tid}:project:{pid}:gateway:{gid}:online
  - tenant:{tid}:project:{pid}:device:{did}:online

### last_value payload（JSON）
- ts_ms：采样时间戳（毫秒）
- value：点位值（字符串化存储）
- quality：质量标记（可选）

### TTL 与一致性策略（MVP）
- TTL（可选）：通过 `EMS_REDIS_LAST_VALUE_TTL_SECONDS` 设置 last_value 过期秒数；未设置或为 0 时不设置 TTL。
- online TTL：通过 `EMS_REDIS_ONLINE_TTL_SECONDS` 设置在线状态过期秒数（默认 60 秒）。
- 一致性：measurement 为事实源；写入顺序为 measurement → last_value。Redis 缺失时实时查询可能为空，需回溯 Timescale。

## 6. 保留策略（先写原则，后落地）
- measurement：按项目/租户的 retention（如 90/180/365 天）
- 压缩策略：按时间窗口压缩
- 复审：当数据量达到阈值时启用自动化 job（scheduler）

## 7. 认证补充（口令与 refresh token）
- `users.password_hash`：存储 Argon2id 哈希（不存明文）。
- `users.refresh_jti`：用于 refresh token rotation（服务端记录当前有效 refresh 的 jti；旧 refresh 自动失效）。修改口令后建议清空该值以撤销所有 refresh。
