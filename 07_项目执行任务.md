# 项目执行任务文档（EMS MVP）

## 目标与范围
- 目标：交付 EMS MVP，可完成登录、项目资源配置、采集写入、实时/历史查询、控制下发与审计闭环。
- 范围：遵循 PRD 与 ADR，后端为模块化单体，前端对接 pure-admin-thin。

## 里程碑（建议）
- M0 环境就绪：WSL2 依赖可一键启动，migrations/seed 可执行。
- M1 账号与项目资源 + 最小前端联调：登录/刷新/动态路由 + 项目/网关/设备/点位 CRUD + 菜单可见/资源列表与新增。
- M2 采集与查询：MQTT ingest → normalize → pipeline → Timescale/Redis；实时/历史查询可用。
- M3 控制链路：命令下发、回执、审计闭环可用。
- M4 前端深度联调：实时/历史/控制/审计页面与权限码打通。
- M5 验收：满足 PRD DoD 场景与稳定性检查。

## 执行任务清单（按模块）
### 1) 环境与基础设施
- [ ] WSL2 统一运行：PG/Timescale、Redis、MQTT 通过 docker-compose 启动（暂不考虑）。
- [x] migrations 初始化表结构；seed 初始化 tenant/project/user/roles/permissions + 示例资产。
- [x] 本地健康检查脚本与说明（pg_isready/psql/redis-cli）。

### 2) 架构与工程骨架
- [x] Rust workspace + crates 目录骨架（core/capability/apps）。
- [x] 模块依赖方向规则落地（domain/api-contract 不反向依赖）。
- [x] 配置加载与环境变量规范（config crate）。

### 3) 认证与权限
- [x] JWT access/refresh 登录链路；/login 与 /refresh-token。
- [x] RBAC 权限码模型与租户隔离 TenantContext。
- [x] /get-async-routes 动态路由输出（兼容 pure-admin-thin）。
- [x] 用户存储切换为 Postgres（不再使用内存）。

### 4) 项目内资源（元数据）
- [x] 项目、网关、设备、点位、点位映射 CRUD。
- [x] 所有表包含 tenant_id 与 project_id，校验归属。

### 5) 采集链路（ingest → normalize → pipeline）
- [ ] MQTT source 接入与 RawEvent 收包。
- [ ] PointMappingProvider 与 Normalizer 映射成 PointValue。
- [ ] pipeline：去重/质量/批写/重试/背压（先 MVP 级实现）。
- [ ] 写入 Timescale measurement + Redis last_value/online。
- [ ] Redis key 规范落地与一致性策略。

### 6) 查询链路
- [ ] realtime 查询：从 Redis 读取 last_value。
- [ ] measurements 查询：Timescale 历史曲线/分页/聚合。

### 7) 控制链路
- [ ] 命令模型：commands、receipts、audit_logs。
- [ ] CommandService 与 Dispatcher（MQTT 下发）。
- [ ] 回执写入 event/receipt，审计记录完整。

### 8) 前端对接
- [x] M1 最小联调：登录/动态路由/菜单可见。
- [x] M1 最小联调：项目资源列表与新增。
- [x] M1 权限码与路由 meta 配置稳定（角色 + auths/permissions）。
- [ ] M4 深度联调：实时/历史、控制与审计页面打通。

### 9) 可观测性与稳定性
- [x] request_id/trace_id 贯穿日志。
- [ ] 数据链路关键节点结构化日志（RawEvent/PointValue/WriteResult）。
- [ ] 基础指标埋点（写入量、失败率、延迟）。

### 10) 验收与回归
- [ ] 用 MQTT 模拟上报点位数据。
- [ ] 登录→创建资源→实时/历史查询→下发控制→审计与回执闭环。
- [ ] 稳定性验证：批写、异常输入、权限隔离。

## 交付物
- API 契约与错误码稳定版。
- migrations/seed 脚本与样例数据。
- 本地一键启动与验证说明。
- MVP 验收用例与操作步骤。

## 约束与前提
- 环境：WSL2 统一运行；Windows 仅作为 IDE 外壳。
- 架构：模块化单体；租户隔离由应用层 TenantContext 保证。
- 存储：Postgres + Timescale + Redis；Redis 作为 last_value/online 镜像。

## MCP/Skill 使用建议
- MCP filesystem/git：统一读取与更新文档、代码与 diff。
- MCP shell/process：执行 migrations/seed、运行服务与本地检查。
- MCP postgres/redis：用只读查询验证数据链路与实时镜像。
- MCP browser/playwright：前端联调与页面验收自动化。
- Skill：仅在需要新增/安装技能时使用 skill-creator 或 skill-installer。
