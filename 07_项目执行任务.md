# 项目执行任务文档（EMS MVP）

## 目标与范围
- 目标：交付 EMS MVP，可完成登录、项目资源配置、采集写入、实时/历史查询、控制下发与审计闭环。
- 范围：遵循 PRD 与 ADR，后端为模块化单体，前端对接 pure-admin-thin。

## 里程碑（建议）
- M0 环境就绪：WSL2 依赖可一键启动，migrations/seed 可执行。
- M1 账号与项目资源 + 最小前端联调：登录/刷新/动态路由 + 项目/网关/设备/点位 CRUD + 菜单可见/资源列表与新增。
- M2 采集与查询：MQTT ingest → normalize → pipeline → Timescale/Redis；实时/历史查询可用。
- M3 控制链路：命令下发、回执、审计闭环可用。
- M4 前端深度联调：实时/历史/控制/审计页面与权限码打通。
- M5 验收：满足 PRD DoD 场景与稳定性检查。

## 下一步执行清单（阶段）
### Phase 0 环境
- [x] `docker-compose`：补齐 Postgres/Timescale、Redis、MQTT 服务与默认账号（WSL2 一键启动）。
- [x] `scripts/db-init.sh`：适配 compose 连接串与初始化顺序。
- [x] `scripts/health-check.sh`：适配 compose 环境与鉴权参数。
- [x] `06_开发环境与工作流_WSL2.md`：更新启动顺序、默认账号、端口与常见故障排查。

### Phase 1 采集链路
- [x] `crates/capability/ingest`：新增 MQTT Source，定义/产出 RawEvent。
- [x] `crates/capability/normalize`：新增 PointMappingProvider 与 Normalizer，产出 PointValue。
- [x] `crates/capability/pipeline`：MVP 级去重/质量/批写/重试/背压已补齐。
- [x] `crates/capability/storage`：新增 Timescale 写入与 Redis last_value/online 写入接口。
- [x] `migrations`：补齐 measurement/event 表与 hypertable 初始化。
- [x] `apps/ems-api`：装配 ingest→normalize→pipeline 运行链路（生命周期管理）。

### Phase 2 查询链路
- [x] `crates/capability/storage`：实现 realtime(last_value) 与 measurements(历史范围+limit+keyset 分页+聚合) 查询。
- [x] `apps/ems-api`：gateways/devices 查询补齐 online 状态（`online/lastSeenAtMs` 从 Redis 读取）。
- [x] `crates/core/api-contract`：补齐 realtime/measurements DTO 与错误码。
- [x] `apps/ems-api`：新增 /realtime 与 /measurements handlers 与路由装配。
- [x] `crates/capability/storage/tests`：查询路径最小测试用例补齐。

### Phase 3 控制链路
- [x] `migrations`：补齐 commands / command_receipts / audit_logs 表结构。
- [x] `crates/capability/control`：新增 CommandService + MQTT Dispatcher（设备侧待对接）。
- [x] `crates/capability/storage`：新增 command/receipt/audit 写入与查询接口。
- [x] `apps/ems-api`：新增 /commands 与 /audit handlers 与路由装配。
- [x] 控制链路闭环验证（模拟回执）。
- [x] 服务端 status 枚举对齐（accepted/success/failed/timeout）+ QoS/重试策略可配置（`EMS_MQTT_COMMAND_QOS`/`EMS_MQTT_RECEIPT_QOS` + `EMS_CONTROL_DISPATCH_*`）。
- [x] 控制回执超时可配置：到期仍为 `accepted` 自动流转 `timeout`（`EMS_CONTROL_RECEIPT_TIMEOUT_SECONDS`）。
- [x] 设备侧模拟器（订阅 commands 自动回执）：`scripts/device-emulator.sh`。
- [x] 真实设备回执对接（按 topic/payload 约定联调；服务端已兼容多种 topic 层级与 payload 字段，见本文档“设备侧回执联调清单”）。

### Phase 4 前端深度联调
- [x] `web/admin`：实时/历史/控制/审计页面接入后端 API。
- [x] `web/admin`：动态路由 meta.auths 与角色/权限码同步。
- [x] `crates/core/api-contract`：确认前后端错误码与字段一致。

### Phase 5 观测与验收
- [x] `crates/capability/telemetry`：补齐 RawEvent/PointValue/WriteResult 结构化日志与写入量/失败率指标埋点。
- [x] `scripts`：新增 MQTT 模拟上报脚本与回归步骤。
- [x] `scripts`：验收/稳定性/RBAC 回归脚本执行结束会自动清理插入的测试数据（避免污染数据库）。
- [x] `09_完成进度.md`：补齐 MVP 验收流记录与验证结果（控制链路模拟回执已完成）。

## 当前状态口径
### 已完成
- web/admin 已拉取（pure-admin-thin），新增 EMS 资源页面与本地 API 代理配置。
- 采集链路闭环验证（MQTT → normalize → pipeline → Timescale/Redis）。
- /realtime 与 /measurements 查询链路与 API 已打通。
- 服务端 RBAC（权限码）已在核心业务接口落地：缺权限返回 `AUTH.FORBIDDEN`。
- pipeline MVP：去重/质量/批写/重试/背压已补齐。
- Redis key 规范/TTL/一致性策略已文档化并落地。
- storage 查询路径最小测试用例已补齐。
- 数据链路结构化日志与写入量/失败率指标埋点已补齐（RawEvent/PointValue/WriteResult）。
- 控制链路表结构与基础 API（/commands、/audit）已落地。
- MQTT 下发与回执写入已接入（设备侧需对接）。
- 控制链路闭环验证已完成（模拟回执）。
- 控制回执模拟脚本已补齐（`scripts/control-receipt-simulate.sh`）。
- 设备侧模拟器已补齐（`scripts/device-emulator.sh`）。
- 稳定性验证脚本已补齐（`scripts/stability-check.sh`）。
- Telemetry 指标快照接口 `/metrics` 已补齐（需要 Bearer token 且具备权限 `SYSTEM.METRICS.READ`），`scripts/mvp-acceptance.sh` 已纳入指标回归断言。

### 进行中
- （无）

### 未开始
- （无）

## 执行任务清单（按模块）
### 1) 环境与基础设施
- [x] WSL2 统一运行：PG/Timescale、Redis、MQTT 通过 docker-compose 启动（暂不考虑）。
- [x] migrations 初始化表结构；seed 初始化 tenant/project/user/roles/permissions + 示例资产。
- [x] 本地健康检查脚本与说明（pg_isready/psql/redis-cli）。

### 2) 架构与工程骨架
- [x] Rust workspace + crates 目录骨架（core/capability/apps）。
- [x] 模块依赖方向规则落地（domain/api-contract 不反向依赖）。
- [x] 配置加载与环境变量规范（config crate）。

### 3) 认证与权限
- [x] JWT access/refresh 登录链路；/login 与 /refresh-token。
- [x] RBAC 权限码模型与租户隔离 TenantContext。
- [x] 服务端 RBAC 权限校验（按 `domain::permissions`；无权限返回 `AUTH.FORBIDDEN`）。
- [x] RBAC 管理面：tenant 级用户/角色/权限管理 API（/rbac/*）+ web/admin 页面。
- [x] /get-async-routes 动态路由输出（兼容 pure-admin-thin）。
- [x] 用户存储切换为 Postgres（不再使用内存）。

### 4) 项目内资源（元数据）
- [x] 项目、网关、设备、点位、点位映射 CRUD。
- [x] 所有表包含 tenant_id 与 project_id，校验归属。

### 5) 采集链路（ingest → normalize → pipeline）
- [x] MQTT source 接入与 RawEvent 收包。
- [x] PointMappingProvider 与 Normalizer 映射成 PointValue。
- [x] pipeline：去重/质量/批写/重试/背压（measurement 批写 + realtime 更新）。
- [x] 写入 Timescale measurement + Redis last_value + online。
- [x] Redis key 规范落地与一致性策略（last_value TTL 可配）。

### 6) 查询链路
- [x] realtime 查询：从 Redis 读取 last_value。
- [x] measurements 查询：历史范围 + limit + keyset 分页 + 聚合（bucketMs/agg）。

### 7) 控制链路
- [x] 命令模型与表结构：commands/command_receipts/audit_logs。
- [x] CommandService + MQTT Dispatcher 与 /commands、/audit 基础 API。
- [x] receipt 回执写入/查询（MQTT 订阅）。
- [x] 审计与回执闭环验证（模拟回执）。
- [ ] 设备侧真实回执对接（topic/payload 约定联调）。

### 8) 前端对接
- [x] M1 最小联调：登录/动态路由/菜单可见。
- [x] M1 最小联调：项目资源列表与新增。
- [x] M1 权限码与路由 meta 配置稳定（角色 + auths/permissions）。
- [x] M4 深度联调：实时/历史、控制与审计页面打通。

### 9) 可观测性与稳定性
- [x] request_id/trace_id 贯穿日志。
- [x] 数据链路关键节点结构化日志（RawEvent/PointValue/WriteResult）。
- [x] 基础指标埋点（写入量/失败率/延迟）。

### 10) 验收与回归
- [x] 用 MQTT 模拟上报点位数据。
- [x] 控制链路闭环（模拟回执）。
- [x] 登录→创建资源→实时/历史查询→下发控制→审计与回执闭环（`scripts/mvp-acceptance.sh`）。
- [x] 稳定性验证：批写、异常输入、权限隔离（`scripts/stability-check.sh`）。

## 设备侧回执联调清单 + 验收步骤（M3）
联调清单：
- 订阅命令主题：`{EMS_MQTT_COMMAND_TOPIC_PREFIX}/{tenant_id}/{project_id}/{command_id}`
  - 可选：若启用 `EMS_MQTT_COMMAND_TOPIC_INCLUDE_TARGET=on`，命令主题为 `{commandPrefix}/{tenant_id}/{project_id}/{target}/{command_id}`
- 回执主题：`{EMS_MQTT_RECEIPT_TOPIC_PREFIX}/{tenant_id}/{project_id}/{command_id}`
  - 兼容（可选）：允许在 `{project_id}` 与 `{command_id}` 之间插入额外层级（例如 target/device 等），服务端会取最后一段作为 command_id
- 命令 payload（下发给设备，camelCase JSON）：
  - `commandId`（必填）
  - `target`（必填）
  - `issuedAtMs`（必填，Unix 毫秒）
  - `payload`（必填，业务 payload 原样透传）
- 回执 payload 字段：`status`（必填）、`message`（可选）、`tsMs`（可选，毫秒）
  - 兼容：`ts_ms`/`ts`/`timestamp`/`timeMs`；`msg`/`detail`；`result`/`state`
- status 建议枚举：`accepted`/`success`/`failed`/`timeout`
- 设备侧执行后必须回执，确保服务端 `command.status` 与审计一致

验收步骤（真实设备）：
1) 开启 `EMS_CONTROL=on` 并发起 `/projects/{project_id}/commands`
2) 设备侧接收命令并执行后回执
3) `/projects/{project_id}/commands/{command_id}/receipts` 有记录
4) `/projects/{project_id}/audit` 有 `CONTROL.COMMAND.RECEIPT` 记录
5) `/projects/{project_id}/commands` 中该命令 `status` 更新

## 验证记录（近期）
- `cargo check -p ems-api`
- `cargo check -p ems-ingest`
- `cargo check -p ems-storage`
- `cargo check -p ems-normalize`
- `cargo check -p ems-pipeline`
- `cargo test -p ems-api`
- RBAC：缺少权限码的请求返回 `AUTH.FORBIDDEN`（用例已补齐）。
- MQTT E2E：`EMS_INGEST=on scripts/mqtt-simulate.sh`，/realtime 与 /measurements 返回数据。
- 控制闭环：`EMS_CONTROL=on` + `scripts/control-receipt-simulate.sh`，/receipts 与 /audit 可查，command.status 更新。
- 一键验收：`scripts/mvp-acceptance.sh`
- 稳定性验证：`scripts/stability-check.sh`

## 交付物
- API 契约与错误码稳定版。
- migrations/seed 脚本与样例数据。
- 本地一键启动与验证说明。
- MVP 验收用例与操作步骤。

## 约束与前提
- 环境：WSL2 统一运行；Windows 仅作为 IDE 外壳。
- 架构：模块化单体；租户隔离由应用层 TenantContext 保证。
- 存储：Postgres + Timescale + Redis；Redis 作为 last_value/online 镜像。

## MCP/Skill 使用建议
- MCP filesystem/git：统一读取与更新文档、代码与 diff。
- MCP shell/process：执行 migrations/seed、运行服务与本地检查。
- MCP postgres/redis：用只读查询验证数据链路与实时镜像。
- MCP browser/playwright：前端联调与页面验收自动化。
- Skill：仅在需要新增/安装技能时使用 skill-creator 或 skill-installer。
