# 完成进度（M0 骨架）

本文件记录当前工程落地进度，便于对照 `07_项目执行任务.md` 验收。

## 已完成
- Rust workspace 骨架（apps + core + capability）。
- M0 认证链路：/login、/refresh-token、/get-async-routes。
- TenantContext 基础结构与 JWT 生成/校验。
- request_id/trace_id 注入与结构化日志初始化。
- 各模块 USAGE 使用说明与最小测试用例。
- 本地构建验证（`cargo build -p ems-api`）。
- migrations/seed 脚本与默认数据（admin）。
- 本地健康检查脚本（Postgres/Redis/MQTT）。
- 用户存储切换为 Postgres（替代内存实现）。
- API 契约 camelCase 与 expires(ms) 对齐 + 契约测试。

## 进行中
- docker-compose 依赖编排。

## 未开始
- 采集链路与控制链路闭环。
- 前端 pure-admin-thin 联调。

## 风险与注意
- 当前依赖 Postgres，需先执行 `scripts/db-init.sh`。
- 未接入真实租户/项目校验逻辑，后续需完善。

## 下一步任务书（M0 未完成 + M1 任务）

### M0 未完成（对照 07/08/09）
- [ ] docker-compose 一键启动依赖（Postgres/Timescale、Redis、MQTT）。
- [x] migrations 初始化表结构 + seed 初始化 tenant/project/user/roles/permissions。
- [x] 本地健康检查脚本与说明（pg_isready/psql/redis-cli）。
- [x] API 契约与错误码补充（与 pure-admin-thin 对齐）。

### pure-admin-thin API 对齐规范（已拉取源码核对）
接口路径（无 `/api` 前缀，前端直接请求）：
- `POST /login`
- `POST /refresh-token`
- `GET /get-async-routes`

请求体字段（camelCase）：
- `/login`：`{ username, password }`
- `/refresh-token`：`{ refreshToken }`

响应结构（前端实际读取字段）：
```json
{
  "success": true,
  "data": {
    "accessToken": "string",
    "refreshToken": "string",
    "expires": 1700000000000,
    "username": "string",
    "nickname": "string",
    "avatar": "string",
    "roles": ["admin"],
    "permissions": ["*:*:*"]
  }
}
```
说明与约束：
- `expires` 采用 Unix 毫秒时间戳，前端 `new Date(expires)` 可直接解析。
- `Authorization: Bearer <accessToken>` 会自动注入到 `/get-async-routes`。
- 动态路由结构需兼容以下字段：
  - `path`、`name`、`component?`（如 `permission/button/index`，需匹配 `src/views` 路径）
  - `meta: { title, icon?, rank?, roles?, auths?, showLink?, frameSrc?, keepAlive?, fixedTag? }`
- 建议后端同时兼容 `/api/*` 与无前缀路径，避免前端改动。

### M1 任务清单（账号与项目资源）
1) 账号与权限
- [x] 登录/刷新/动态路由的字段名与路径对齐（camelCase，无前缀路径）。
- [ ] 角色/权限码稳定化（参考 `05_API契约与前端对接.md`）。
- [ ] TenantContext 与 project_id 归属校验补全。

2) 元数据 CRUD
- [ ] 项目（projects）增删改查。
- [ ] 网关/设备/点位/点位映射 CRUD（路径按 `05_API契约与前端对接.md`）。
- [ ] 所有表包含 tenant_id + project_id；所有访问显式接收 TenantContext。

3) 存储替换与基础联调
- [ ] storage 内存实现替换为 PG/Timescale（最小可用）。
- [ ] seed 数据覆盖前端演示所需最小资产。
- [ ] 前端联调：登录 → 路由 → 资源列表/新增。
