# 完成进度（M0 骨架）

本文件记录当前工程落地进度，便于对照 `07_项目执行任务.md` 验收。

## M1 口径
- 账号与项目资源 + 最小前端联调（登录/刷新/动态路由、菜单可见、项目资源列表/新增）。

## 已完成
- Rust workspace 骨架（apps + core + capability）。
- M0 认证链路：/login、/refresh-token、/get-async-routes。
- TenantContext 基础结构与 JWT 生成/校验。
- request_id/trace_id 注入与结构化日志初始化。
- 各模块 USAGE 使用说明与最小测试用例。
- 本地构建验证（`cargo build -p ems-api`）。
- migrations/seed 脚本与默认数据（admin）。
- 本地健康检查脚本（Postgres/Redis/MQTT，支持认证）。
- 用户存储切换为 Postgres（替代内存实现）。
- API 契约 camelCase 与 expires(ms) 对齐 + 契约测试。
- Redis ACL 与 Mosquitto 账号密码配置（本地环境）。
- 动态路由叶子节点省略 `children`，前端菜单渲染正常（EMS 模块出现）。

## 进行中
- docker-compose 依赖编排。
- 前端联调（项目资源列表与新增）。
- web/admin 已拉取（pure-admin-thin），新增 EMS 资源页面与本地 API 代理配置。

## 未开始
- 采集链路与控制链路闭环。
- 前端深度联调（实时/历史/控制/审计页面）。

## 风险与注意
- 当前依赖 Postgres，需先执行 `scripts/db-init.sh`。
- Redis/MQTT 已启用认证，依赖 `.env` 中的连接参数。
- 项目归属校验已接入 CRUD 接口（project_id 校验）。

## 验证记录
- API 最小增删链路（项目/网关/设备/点位/映射）已跑通并完成清理。
  - projectId: `51a3c686-4d6c-46d1-b40e-5407715955e5`
  - gatewayId: `33bd2574-3f70-483b-af74-261c747f8e7c`
  - deviceId: `994fa89e-9644-44aa-83d2-a30ab529ff0c`
  - pointId: `00924bbb-df7e-4910-b872-48024ffb443d`
  - sourceId: `a5ffa2a4-27f0-40a3-a47c-36ee8a1c8a3b`
- `cargo test -p ems-api`（handlers auth/projects）通过。
- 前端联调验证：`web/admin` 启动可访问（http://localhost:8848/），`/login` 与 `/get-async-routes` API 返回正常；Playwright + 系统 Chrome 自动登录完成。
- 前端登录已完成（admin/admin123），动态路由菜单已可见（EMS 模块出现）。
- Playwright + 系统 Chrome 自动登录验证：菜单出现 EMS/项目/网关/设备/点位/点位映射。

## 前端联调排查清单（M1 优先）
- 动态路由 component 映射：`web/admin/src/router/utils.ts` 使用 `import.meta.glob("/src/views/**/*.{vue,tsx}")`，`component` 或 `path` 需能被 `includes` 命中（例如 `ems/projects/index`）。
- 顶层路由 `component` 应为 `Layout`，子路由为具体页面组件路径。
- `meta.roles` 需与登录返回 `roles` 有交集，否则菜单会被过滤。
- 按钮权限基于 `meta.auths` 与登录返回 `permissions`，不影响菜单展示但影响按钮显示。
- 如果开启 `CachingAsyncRoutes`，需清理 localStorage `async-routes` 以避免旧路由缓存。
- 叶子节点 `children` 为空时应省略字段，否则会被菜单过滤（已修复）。

## 下一步任务书（M0 未完成 + M1 任务）

### M0 未完成（对照 07/08/09）
- [ ] docker-compose 一键启动依赖（Postgres/Timescale、Redis、MQTT）（暂不考虑）。
- [x] migrations 初始化表结构 + seed 初始化 tenant/project/user/roles/permissions。
- [x] 本地健康检查脚本与说明（pg_isready/psql/redis-cli）。
- [x] Redis/MQTT 认证配置与验证。
- [x] API 契约与错误码补充（与 pure-admin-thin 对齐）。

### pure-admin-thin API 对齐规范（已拉取源码核对）
接口路径（无 `/api` 前缀，前端直接请求）：
- `POST /login`
- `POST /refresh-token`
- `GET /get-async-routes`

请求体字段（camelCase）：
- `/login`：`{ username, password }`
- `/refresh-token`：`{ refreshToken }`

响应结构（前端实际读取字段）：
```json
{
  "success": true,
  "data": {
    "accessToken": "string",
    "refreshToken": "string",
    "expires": 1700000000000,
    "username": "string",
    "nickname": "string",
    "avatar": "string",
    "roles": ["admin"],
    "permissions": [
      "PROJECT.READ",
      "PROJECT.WRITE",
      "ASSET.GATEWAY.READ",
      "ASSET.GATEWAY.WRITE",
      "ASSET.DEVICE.READ",
      "ASSET.DEVICE.WRITE",
      "ASSET.POINT.READ",
      "ASSET.POINT.WRITE",
      "DATA.REALTIME.READ",
      "DATA.MEASUREMENTS.READ",
      "CONTROL.COMMAND.ISSUE",
      "CONTROL.COMMAND.READ",
      "ALARM.RULE.READ",
      "ALARM.RULE.WRITE",
      "ALARM.EVENT.READ"
    ]
  }
}
```
说明与约束：
- `expires` 采用 Unix 毫秒时间戳，前端 `new Date(expires)` 可直接解析。
- `Authorization: Bearer <accessToken>` 会自动注入到 `/get-async-routes`。
- 动态路由结构需兼容以下字段：
  - `path`、`name`、`component?`（如 `permission/button/index`，需匹配 `src/views` 路径）
  - `meta: { title, icon?, rank?, roles?, auths?, showLink?, frameSrc?, keepAlive?, fixedTag? }`
- 建议后端同时兼容 `/api/*` 与无前缀路径，避免前端改动。

### M1 任务清单（账号与项目资源 + 最小前端联调）
1) 账号与权限
- [x] 登录/刷新/动态路由的字段名与路径对齐（camelCase，无前缀路径）。
- [x] 角色/权限码稳定化（参考 `05_API契约与前端对接.md`）。
- [x] TenantContext 与 project_id 归属校验补全。

2) 元数据 CRUD
- [x] 项目（projects）增删改查。
- [x] 网关/设备/点位/点位映射 CRUD（路径按 `05_API契约与前端对接.md`）。
- [x] 所有表包含 tenant_id + project_id；所有访问显式接收 TenantContext。

3) 存储替换与基础联调
- [x] storage 内存实现替换为 PG（Timescale 表留待采集链路接入）。
- [x] seed 数据覆盖前端演示所需最小资产。
- [ ] 前端联调：登录 → 路由/菜单 → 资源列表/新增（动态路由已补齐）。
