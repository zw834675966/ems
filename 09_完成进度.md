# 完成进度（M0-M2）

本文件记录当前工程落地进度，便于对照 `07_项目执行任务.md` 验收。

## M1 口径
- 账号与项目资源 + 最小前端联调（登录/刷新/动态路由、菜单可见、项目资源列表/新增）。

## 已完成
- Rust workspace 骨架（apps + core + capability）。
- M0 认证链路：/login、/refresh-token、/get-async-routes。
- TenantContext 基础结构与 JWT 生成/校验。
- 服务端 RBAC 权限校验（按 `domain::permissions`）：缺少权限码返回 `AUTH.FORBIDDEN`。
- RBAC 管理面：tenant 级用户/角色/权限管理 API（/rbac/*）+ web/admin 页面已补齐。
- request_id/trace_id 注入与结构化日志初始化。
- 各模块 USAGE 使用说明与最小测试用例。
- 本地构建验证（`cargo build -p ems-api`）。
- migrations/seed 脚本与默认数据（admin）。
- 本地健康检查脚本（Postgres/Redis/MQTT，支持认证）。
- docker-compose 依赖编排（Postgres/Timescale、Redis、MQTT）文件与本地配置。
- 用户存储切换为 Postgres（替代内存实现）。
- API 契约 camelCase 与 expires(ms) 对齐 + 契约测试。
- Redis ACL 与 Mosquitto 账号密码配置（本地环境）。
- 动态路由叶子节点省略 `children`，前端菜单渲染正常（EMS 模块出现）。
- 前端联调：登录 → 路由/菜单 → 资源列表/新增（Playwright 已验证）。
- 采集链路骨架：RawEvent → PointValue → Pipeline 接线（Noop/MQTT 可切换）。
- MQTT Source 接入与 topic 解析（tenant/project/address）。
- Timescale measurement/event 迁移与（timescaledb 可用时）hypertable 初始化脚本；可用 `EMS_REQUIRE_TIMESCALE=on` 强制要求并 fail-fast。
- measurement 写入 + Redis last_value 写入与查询接口。
- online 状态：采集写入触达 Redis + TTL 配置（`EMS_REDIS_ONLINE_TTL_SECONDS`）+ gateways/devices 响应透出 `online/lastSeenAtMs`。
- /realtime 与 /measurements API 与 DTO 完整接入（measurements 支持 keyset 分页与聚合：cursorTsMs/order/bucketMs/agg）。
- MQTT 模拟上报脚本（`scripts/mqtt-simulate.sh`）。
- 采集链路闭环验证（MQTT → normalize → pipeline → Timescale/Redis）。
- web/admin 已拉取（pure-admin-thin），新增 EMS 资源页面与本地 API 代理配置。
- pipeline MVP：去重/质量/批写/重试/背压已补齐。
- Redis key 规范/TTL/一致性策略已文档化并落地。
- storage 查询路径最小测试用例已补齐（realtime/measurements）。
- 数据链路结构化日志与写入量/失败率指标埋点已补齐（RawEvent/PointValue/WriteResult）。
- 延迟指标埋点（写入延迟、端到端延迟）。
- 控制链路表结构与基础 API（/commands、/audit）已落地。
- MQTT Dispatcher + receipt 回执写入已接入（设备侧需对接）。
- 控制回执模拟脚本：`scripts/control-receipt-simulate.sh`。
- 控制链路闭环验证（/commands → receipt → /audit）已通过（模拟回执）。
- Command 结构化日志与指标补齐（issue/dispatch/receipt）。
- Telemetry 指标快照接口 `/metrics` 已补齐（需要 Bearer token 且具备权限 `SYSTEM.METRICS.READ`），`scripts/mvp-acceptance.sh` 已纳入指标回归断言。
- 前端深度联调（M4 最小页面）：实时/历史/控制/审计页面已接入后端 API + 动态路由 meta.auths 同步。
- MVP 验收脚本：`scripts/mvp-acceptance.sh`（登录→创建资源→实时/历史→控制→审计/回执）。
- 设备侧模拟器：`scripts/device-emulator.sh`（订阅 commands 自动回执）。
- 稳定性验证脚本：`scripts/stability-check.sh`（批写/异常输入/租户隔离/控制闭环）。

## 进行中
- （无）

## 未开始
- （无）

## 风险与注意
- 当前依赖 Postgres，需先执行 `scripts/db-init.sh`。
- Redis/MQTT 已启用认证，依赖 `.env` 中的连接参数。
- 项目归属校验已接入 CRUD 接口（project_id 校验）。
- `EMS_INGEST` 默认 off；启用后 MQTT 主题默认形如 `ems/data/{tenant_id}/{project_id}/{address}`（可用 `EMS_MQTT_DATA_TOPIC_PREFIX` 覆盖），address 对应 point_sources.address。若开启 `EMS_MQTT_DATA_TOPIC_HAS_SOURCE_ID=on`，主题形如 `ems/data/{tenant_id}/{project_id}/{source_id}/{address}`。
- 建议使用 `EMS_MQTT_DATA_TOPIC_PREFIX`（默认 `ems/data`）以避免采集与控制 topic 冲突。

## 验证记录
- API 最小增删链路（项目/网关/设备/点位/映射）已跑通并完成清理。
  - projectId: `51a3c686-4d6c-46d1-b40e-5407715955e5`
  - gatewayId: `33bd2574-3f70-483b-af74-261c747f8e7c`
  - deviceId: `994fa89e-9644-44aa-83d2-a30ab529ff0c`
  - pointId: `00924bbb-df7e-4910-b872-48024ffb443d`
  - sourceId: `a5ffa2a4-27f0-40a3-a47c-36ee8a1c8a3b`
- `cargo test -p ems-api`（含 projects 权限校验用例）通过。
- 编译验证（本地）：`cargo check -p ems-storage`、`cargo check -p ems-normalize`、`cargo check -p ems-pipeline`、`cargo check -p ems-ingest`、`cargo check -p ems-api`。
- MQTT 端到端验证通过：`EMS_INGEST=on scripts/mqtt-simulate.sh` 上报 `ems/data/tenant-1/project-1/demo/topic`，/realtime 与 /measurements 返回 point-1 的 `12.3`。
- 在线状态验证：MQTT 上报后，`GET /projects/{project_id}/gateways` 与 `GET /projects/{project_id}/devices` 返回 `online=true` 且 `lastSeenAtMs` 有值（见验收脚本）。
- 控制闭环验证通过：/commands 下发 → `scripts/control-receipt-simulate.sh` 回执 → /receipts 与 /audit 可查，command.status 更新为 success。
- measurements 聚合查询验证通过（bucketMs/agg），已纳入 `scripts/mvp-acceptance.sh` 与 `scripts/stability-check.sh`。

### MQTT 端到端复现步骤（本次）
```bash
scripts/db-init.sh
scripts/health-check.sh

EMS_JWT_SECRET=dev \
EMS_JWT_ACCESS_TTL_SECONDS=3600 \
EMS_JWT_REFRESH_TTL_SECONDS=7200 \
EMS_INGEST=on \
EMS_MQTT_USERNAME=ems \
EMS_MQTT_PASSWORD=admin123 \
EMS_MQTT_TOPIC_PREFIX=ems \
EMS_MQTT_DATA_TOPIC_PREFIX=ems/data \
cargo run -p ems-api

EMS_MQTT_USERNAME=ems EMS_MQTT_PASSWORD=admin123 EMS_MQTT_TOPIC_PREFIX=ems EMS_MQTT_DATA_TOPIC_PREFIX=ems/data \
scripts/mqtt-simulate.sh

ACCESS_TOKEN=$(curl -sS -X POST http://127.0.0.1:8080/login \
  -H "Content-Type: application/json" \
  -d '{"username":"admin","password":"admin123"}' \
  | python3 -c 'import json,sys; print(json.load(sys.stdin)["data"]["accessToken"])')

curl -sS "http://127.0.0.1:8080/projects/project-1/realtime?pointId=point-1" \
  -H "Authorization: Bearer $ACCESS_TOKEN"

curl -sS "http://127.0.0.1:8080/projects/project-1/measurements?pointId=point-1&limit=10" \
  -H "Authorization: Bearer $ACCESS_TOKEN"
```
- 前端联调验证：`web/admin` 启动可访问（http://localhost:8848/），`/login` 与 `/get-async-routes` API 返回正常；Playwright + 系统 Chrome 自动登录完成。
- 前端登录已完成（admin/admin123），动态路由菜单已可见（EMS 模块出现）。
- Playwright + 系统 Chrome 自动登录验证：菜单出现 EMS/项目/网关/设备/点位/点位映射。
- 前端 M1 联调全链路（列表/新增）验证通过：
  - projectId: `3ce81416-72a9-406e-bcfc-43c7749d9960`
  - gatewayId: `c067289a-7113-46d0-a733-aa5f6d27fb43`
  - deviceId: `d781c24a-4ae6-495b-97c4-08fe426bef65`
  - pointId: `86da66a8-99dd-4e3e-9db6-a8607efea7df`
  - sourceId: `a6f0ba20-3dee-477a-a7a7-2c042f0d09ef`

## 前端联调排查清单（M1 优先）
- 动态路由 component 映射：`web/admin/src/router/utils.ts` 使用 `import.meta.glob("/src/views/**/*.{vue,tsx}")`，`component` 或 `path` 需能被 `includes` 命中（例如 `ems/projects/index`）。
- 顶层路由 `component` 应为 `Layout`，子路由为具体页面组件路径。
- `meta.roles` 需与登录返回 `roles` 有交集，否则菜单会被过滤。
- 按钮权限基于 `meta.auths` 与登录返回 `permissions`，不影响菜单展示但影响按钮显示。
- 如果开启 `CachingAsyncRoutes`，需清理 localStorage `async-routes` 以避免旧路由缓存。
- 叶子节点 `children` 为空时应省略字段，否则会被菜单过滤（已修复）。

## 下一步任务书（M2/M3）

### M2 采集与查询补齐

### M3 控制链路
- [x] migrations：commands/command_receipts/audit_logs 表结构。
- [x] capability/control：CommandService + MQTT Dispatcher。
- [x] storage：command/receipt/audit 写入与查询接口。
- [x] ems-api：/commands 与 /audit handlers 与路由装配。
- [x] MQTT receipt 回执写入/查询。
- [x] 审计与回执闭环验证（模拟回执通过）。

### M4 前端深度联调
- [x] web/admin：实时/历史/控制/审计页面接入后端 API。
- [x] web/admin：动态路由 meta.auths 与角色/权限码同步。

### pure-admin-thin API 对齐规范（已拉取源码核对）
接口路径（无 `/api` 前缀，前端直接请求）：
- `POST /login`
- `POST /refresh-token`
- `GET /get-async-routes`

请求体字段（camelCase）：
- `/login`：`{ username, password }`
- `/refresh-token`：`{ refreshToken }`

响应结构（前端实际读取字段）：
```json
{
  "success": true,
  "data": {
    "accessToken": "string",
    "refreshToken": "string",
    "expires": 1700000000000,
    "username": "string",
    "nickname": "string",
    "avatar": "string",
    "roles": ["admin"],
    "permissions": [
      "PROJECT.READ",
      "PROJECT.WRITE",
      "ASSET.GATEWAY.READ",
      "ASSET.GATEWAY.WRITE",
      "ASSET.DEVICE.READ",
      "ASSET.DEVICE.WRITE",
      "ASSET.POINT.READ",
      "ASSET.POINT.WRITE",
      "DATA.REALTIME.READ",
      "DATA.MEASUREMENTS.READ",
      "CONTROL.COMMAND.ISSUE",
      "CONTROL.COMMAND.READ",
      "ALARM.RULE.READ",
      "ALARM.RULE.WRITE",
      "ALARM.EVENT.READ"
    ]
  }
}
```
说明与约束：
- `expires` 采用 Unix 毫秒时间戳，前端 `new Date(expires)` 可直接解析。
- `Authorization: Bearer <accessToken>` 会自动注入到 `/get-async-routes`。
- 动态路由结构需兼容以下字段：
  - `path`、`name`、`component?`（如 `permission/button/index`，需匹配 `src/views` 路径）
  - `meta: { title, icon?, rank?, roles?, auths?, showLink?, frameSrc?, keepAlive?, fixedTag? }`
- 建议后端同时兼容 `/api/*` 与无前缀路径，避免前端改动。

### M1 任务清单（账号与项目资源 + 最小前端联调）
1) 账号与权限
- [x] 登录/刷新/动态路由的字段名与路径对齐（camelCase，无前缀路径）。
- [x] 角色/权限码稳定化（参考 `05_API契约与前端对接.md`）。
- [x] 路由 `meta.auths` 绑定 READ/WRITE 权限码，菜单与按钮权限口径一致。
- [x] TenantContext 与 project_id 归属校验补全。

2) 元数据 CRUD
- [x] 项目（projects）增删改查。
- [x] 网关/设备/点位/点位映射 CRUD（路径按 `05_API契约与前端对接.md`）。
- [x] 所有表包含 tenant_id + project_id；所有访问显式接收 TenantContext。

3) 存储替换与基础联调
- [x] storage 内存实现替换为 PG（Timescale 表留待采集链路接入）。
- [x] seed 数据覆盖前端演示所需最小资产。
- [x] 前端联调：登录 → 路由/菜单 → 资源列表/新增（动态路由已补齐）。
