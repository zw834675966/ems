# WSL2 开发环境与工作流

## 1. 运行环境原则
- Windows 仅作为 IDE 外壳（VSCode Remote WSL）
- 所有进程跑在 WSL2：ems-api + PG/Timescale + Redis + MQTT

## 2. 依赖组件与职责
- Postgres/Timescale：元数据 + 时序
- Redis：last_value/online 等热数据
- MQTT Broker：采集/控制通道

## 3. 初始化流程（步骤级）
1) 在 WSL2 启动 docker-compose 依赖（PG/TS/Redis/MQTT）
2) 执行 migrations 初始化表结构
3) 执行 seed 初始化：
   - tenant + project + user + roles/permissions
   - 示例 gateway/device/point/point_source
4) 启动 ems-api
5) 用 Swagger 或 Postman 验证闭环：
   - 登录获取 token
   - 创建/查询项目资源
   - MQTT 模拟上报数据
   - 查询 realtime 与历史
   - 下发控制并查询审计/回执

## 4. 本地调试建议
- trace_id/request_id：每个请求都打印，便于串联排障
- 数据链路：RawEvent / PointValue / WriteResult 关键节点要有结构化日志

## 5. 开发规范（最小一套）
- crates 依赖方向必须遵循架构文档
- 禁止在 handler 里直接写 SQL（统一走 storage）
- 任何访问数据的方法必须显式接收 TenantContext
