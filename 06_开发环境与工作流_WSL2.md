# WSL2 开发环境与工作流

## 1. 运行环境原则
- Windows 仅作为 IDE 外壳（VSCode Remote WSL）
- 所有进程跑在 WSL2：ems-api + PG/Timescale + Redis + MQTT

## 2. 依赖组件与职责
- Postgres/Timescale：元数据 + 时序
- Redis：last_value/online 等热数据
- MQTT Broker：采集/控制通道

## 2.1 本地默认账号
- Postgres：ems / admin123（db: ems）
- Redis：default / admin123
- MQTT（Mosquitto）：ems / admin123

## 3. 初始化流程（步骤级）
1) 启动依赖（两种方式任选其一）
   - 方式 A（推荐：Docker/Compose 可用时）：`docker compose up -d`
   - 方式 B（本机服务）：启用 systemd 后启动 `postgresql` / `redis-server` / `mosquitto`（见 `README.md`）
2) 执行 migrations + seed（`scripts/db-init.sh`）
   - 默认连接串：`postgresql://ems:admin123@localhost:5432/ems`
3) 执行本地健康检查（`scripts/health-check.sh`）
4) 启动 ems-api（可选前端联动）
   - 仅后端：`cargo run -p ems-api`
   - 前后端联动：`EMS_WEB_ADMIN=on cargo run -p ems-api`
5) 用 Swagger 或 Postman 验证闭环：
   - tenant + project + user + roles/permissions
   - 示例 gateway/device/point/point_source
   - 登录获取 token
   - 创建/查询项目资源
   - MQTT 模拟上报数据
   - 查询 realtime 与历史
   - 下发控制并查询审计/回执（模拟器已可用；真实设备回执协议需联调）

## 4. 本地调试建议
- trace_id/request_id：每个请求都打印，便于串联排障
- 数据链路：RawEvent / PointValue / WriteResult 关键节点要有结构化日志

### 4.3 指标快照（MVP）
`GET /metrics` 返回当前进程内的聚合计数（用于回归验证 ingest/control 是否有数据流入）。
- 需要 Bearer token 且具备权限 `SYSTEM.METRICS.READ`（默认 admin 种子用户具备）
- 建议仅内网开放或做网段限制

### 4.4 健康探针
- `GET /livez`：存活探针（`/health` 等价于 `/livez`）
- `GET /readyz`：就绪探针（检查 Postgres 连接）

## 4.1 MQTT 模拟上报
```bash
EMS_INGEST=on scripts/mqtt-simulate.sh
```

## 4.2 一键验收脚本
- MVP 闭环：`scripts/mvp-acceptance.sh`
- 稳定性回归：`scripts/stability-check.sh`
- RBAC 管理面回归：`scripts/rbac-acceptance.sh`

## 5. 开发规范（最小一套）
- crates 依赖方向必须遵循架构文档
- 禁止在 handler 里直接写 SQL（统一走 storage）
- 任何访问数据的方法必须显式接收 TenantContext

## 6. 前端联调补充
- 关闭 mock：在 `web/admin/.env.development` 中设置 `VITE_ENABLE_MOCK = false`。
- 动态路由叶子节点 `children` 为空时应省略字段，避免菜单过滤。

## 7. 运行期环境变量补充
- `EMS_REDIS_URL`：运行期 Redis 连接串（默认 `redis://default:admin123@localhost:6379`）。
- `EMS_REDIS_LAST_VALUE_TTL_SECONDS`：last_value 过期秒数（可选，未设置或为 0 则不设置 TTL）。
- `EMS_REDIS_ONLINE_TTL_SECONDS`：online 过期秒数（默认 60 秒）。
- `EMS_MQTT_HOST` / `EMS_MQTT_PORT`：MQTT 连接信息（默认 `127.0.0.1:1883`）。
- `EMS_MQTT_USERNAME` / `EMS_MQTT_PASSWORD`：MQTT 账号（可选）。
- `EMS_MQTT_TOPIC_PREFIX`：MQTT 根前缀（默认 `ems`）。
- `EMS_MQTT_DATA_TOPIC_PREFIX`：采集订阅前缀（默认 `{EMS_MQTT_TOPIC_PREFIX}/data`，主题形如 `{dataPrefix}/{tenant_id}/{project_id}/{address}`）。
- `EMS_MQTT_DATA_TOPIC_HAS_SOURCE_ID`：采集 topic 是否包含 source_id（默认 off；开启后主题形如 `{dataPrefix}/{tenant_id}/{project_id}/{source_id}/{address}`）。
- `EMS_MQTT_COMMAND_TOPIC_PREFIX`：控制下发主题前缀（默认 `{EMS_MQTT_TOPIC_PREFIX}/commands`）。
- `EMS_MQTT_COMMAND_TOPIC_INCLUDE_TARGET`：命令 topic 是否包含 target（默认 off；开启后主题形如 `{commandPrefix}/{tenant_id}/{project_id}/{target}/{command_id}`）。
- `EMS_MQTT_RECEIPT_TOPIC_PREFIX`：回执订阅主题前缀（默认 `{EMS_MQTT_TOPIC_PREFIX}/receipts`）。
- `EMS_MQTT_COMMAND_QOS`：控制下发 QoS（0/1/2，默认 1）。
- `EMS_MQTT_RECEIPT_QOS`：回执订阅 QoS（0/1/2，默认 1）。
- `EMS_INGEST`：是否启用 MQTT 采集（默认 `off`）。
- `EMS_CONTROL`：是否启用控制下发与回执订阅（默认 `off`）。
- `EMS_CONTROL_DISPATCH_MAX_RETRIES`：控制下发重试次数（默认 2，表示最多尝试 3 次）。
- `EMS_CONTROL_DISPATCH_BACKOFF_MS`：控制下发重试退避毫秒（默认 200）。
- `EMS_CONTROL_RECEIPT_TIMEOUT_SECONDS`：等待设备回执超时秒数（默认 30 秒；到期仍为 accepted 则自动置为 timeout）。
